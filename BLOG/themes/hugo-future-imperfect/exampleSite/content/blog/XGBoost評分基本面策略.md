# XGBoost評分基本面策略

## 一、 前言

因子選股常是量化投資策略之中被認為是重點的一塊。就如同NBA選秀時需要球員做基本的體能測試與測量，作為未來在NBA表現的指標一樣，因子選股就是希望可以代表未來高報酬率的指標，也就是因子。

在這篇研究中，我們希望可以利用這些因子作為自變數，並使同期的報酬作為應變數，並將機器學習模型預測出來的報酬作為模型對該公司的評分，當作是新的因子。

![](https://i.imgur.com/o4WREsb.png)

但與股價報酬相關的指標何其多，包含經濟面、基本面、技術面，要將哪些因子納入考量之中呢?

## 二、 變數

我們篩選的條件大概包含以下幾點
1. 大部分的公司財報有揭露
2. 傳統上認為對報酬率有影響

### 1. 因子選取

從公開的財報資料蒐集以下的因子作為因子選股的基準：

#### 財報因子
在財報方面，我們大概將需要的因子區分成以下的面向：
- 價值 
    - EPS/收盤價
    - P/B ratio / 收盤價
    
- 獲利
    - ROE
    - ROA
    - 毛利率
    - EBIT 
- 槓桿 
    - 總權益/總負債
    - 總資產/總負債
- 流動 
    - 流動比率
    - 速動比率
- 營運
    - 營運現金流 / 總資產
    - 長債/(流動資產-流動負債)
- 市值
- 營收

#### 動能因子
在動能方面，我們採計了樣本期間內的日報酬並計算相關的以下因子
- 報酬率波動度
- 報酬率震幅


#### 同期報酬率
最後作為模型裡需要預測的目標，我們抓取同期的月報酬，作為模型訓練的指標。試圖讓模型可以為我們預測報酬率，作為一種評分。

#### 結果

最後的收集完成的因子每個月更新依次，其中部分如下表呈現：



```R
head(factorTable, 10)
```

| code | name | date | epRatio | bpRatio | salesToPriceRatio | roe | roa | nextPeriodRet |
|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|
| 1101 | 台泥 | 20100110 | 0.072798819 | 1.149040826 | 0.234628628 | 0.0655 | 0.0605 | -0.169208067 |
| 1102 | 亞泥 | 20100110 |  0.107194592 | 1.158860454 | 0.12409464 | 0.0969 | 0.0733 | -0.151398264 |
| 1103 | 嘉泥 | 20100110 |  0.053795136 | 2.138540899 | 0.223286662 | 0.0257 | 0.0137 | -0.18128224 |
| 1104 | 環泥 | 20100110 |  0.033605813 | 1.812897366 | 0.364214351 | 0.0192 | 0.0174 | -0.12897366 |
| 1108 | 幸福 | 20100110 |  0.023021583 | 1.520863309 | 0.74676259 | 0.015 | 0.0344 | -0.195435093 |
| 1109 | 信大 | 20100110 |  0.029036005 | 1.681765389 | 0.296167247 | 0.0173 | 0.026 | -0.117919075 |
| 1110 | 東泥 | 20100110 |  0.031394275 | 1.370267775 | 0.200369344 | 0.0236 | 0.0216 | -0.140781108 |
| 1201 | 味全 | 20100110 |  0.025412961 | 0.270393901 | 0.47090216 | 0.0986 | 0.0639 | -0.199693565 |
| 1203 | 味王 | 20100110 |  0.133449883 | 1.143939394 | 0.591491841 | 0.1233 | 0.0897 | -0.080139373 |
| 1210 | 大成 | 20100110 |  0.160026127 | 1.417374265 | 2.240365774 | 0.1175 | 0.087 | -0.116233766 |


### 2. 資料處理

#### 資料頻率處理

由於這些因子有些是來自於年報或者是季報，不同的因子頻率從年、季、月、日都有，為了不要使用未來資料以及預測模型方便的選擇，將季頻與年頻的資料透過oversampling的方式月頻的樣本數，使資料平衡。


#### 缺值處理

由於採用的因子非常多，且也多個財報資料相除的數值，所以當進行運算的因子呈現0或是缺值時，及有可能有些公司的因子值會是0、或是無限(Inf)或是缺值。
遇到這樣的情形則是直接刪除樣本，使這些問題資料不會影響結果。

#### 標準化

接下來要進行的是因子的標準化。由於每個因子的性質不大相同，分配也不盡相同，所以需要對於變數進行標準化確保模型運算結果。

其中採用兩種標準化方式
- 壓縮離群值
定義資料平均數+-三倍標準差為值域上下限，超出則定義為離群值，並將這些離群值以上下限取代。
- Z-Score
將壓縮過後的結果用Z-Score標準化，並將整個分布壓為0-1的值域，以達到分數的效果。

#### 結果

最後處理完成的因子部分如下所示：

| epRatio     | bpRatio     | salesToPriceRatio | roe         | roa         | grossProfitMargin | ebit        |
|:-:|:-:|:-:|:-:|:-:|:-:|:-:|
| 0.679691578 | 0.519795426 | 0.292480234       | 0.633666667 | 0.608962264 | 0.478716725       | 0.737465399 |
| 0.687488176 | 0.658011432 | 0.207628609       | 0.539666667 | 0.55        | 0.37474887        | 0.757229702 |
| 0.502778076 | 0.827095521 | 0.130501173       | 0.412666667 | 0.381603774 | 0.221433953       | 0.602714164 |
| 0.651342559 | 0.574763038 | 0.121420837       | 0.562       | 0.581603774 | 0.348631341       | 0.797883312 |
| 0.679918596 | 0.797574027 | 0.556337144       | 0.498       | 0.570754717 | 0.398982923       | 0.512437452 |
| 0.50336548  | 0.66686232  | 0.263868173       | 0.433333333 | 0.478773585 | 0.416185334       | 0.481374383 |
| 0.466745188 | 0.521645028 | 0.063433362       | 0.447666667 | 0.465566038 | 0.411664992       | 0.609998573 |
| 0.530722327 | 0.310233972 | 0.375559912       | 0.588333333 | 0.551415094 | 0.645090407       | 0.475767453 |
| 0.627339125 | 0.493570048 | 0.400582283       | 0.612333333 | 0.610849057 | 0.509731291       | 0.557842081 |
| 0.724154848 | 0.704679068 | 1                 | 0.501333333 | 0.517924528 | 0.347124561       | 0.389363044 |





## 三、 建構模型

#### 1. 訓練期與測試期

由於我們模型每半年訓練一次，呈現如下圖。
![](https://i.imgur.com/3Q10xF2.png)

依照此比例依序切割，每半年滾動訓練一次。



#### 2. 模型

使用XGBoost模型：
```R
xgbModel <- xgb.train(data = trainData,
                            params = params,
                            nrounds = bestIteration)
```


#### 3. 預測結果

```R
predictTestValue <- predict(xgbModel, testData)
```

| code | name | date | predictValue |
|:-:|:-:|:-:|:-:|
| 1101 | 台泥 | 20140110 | 0.543941557 |
| 1102 | 亞泥 | 20140110 | 0.522379637 |
| 1103 | 嘉泥 | 20140110 | 0.52585572 |
| 1104 | 環泥 | 20140110 | 0.55059886 |
| 1108 | 幸福 | 20140110 | 0.548635125 |
| 1109 | 信大 | 20140110 | 0.55987519 |
| 1110 | 東泥 | 20140110 | 0.563570619 |
| 1201 | 味全 | 20140110 | 0.528556108 |
| 1203 | 味王 | 20140110 | 0.551757753 |
| 1210 | 大成 | 20140110 | 0.553272843 |


把原始的預測值乘以100，作為選出優秀股票的評分。

## 四、 績效
辛苦的得到對於每間公司的評分之後，我們需要把這些評分進行回測，確保在這些評分的效用。


### 1. 原始績效


既然因子資料是月頻，則回測使用月頻交易，在營收公布日隔天換倉。

- 回測期間：20140101-20190210
- 策略：選出分數前n高的公司進場。

- 限制：**交易量**五日均量須超過1000張(約300-500家)
其報酬如下：

| n | 累計收益率 | 年化收益率 |年化標準差 | 年化夏普比率 | 最大回撤率 |
|:-:|:-:|:-:|:-:|:-:|:-:|
| 10 | 62.07% | 10.22% | 23.81% | 0.5293 | -35.72% |
| 20 | 93.96% | 14.29% | 20.37% | 0.7585 | -30.8% |
| 30 | 128.44% | 18.12% | 19.35% | 0.9586 | -28.6% |
| 40 | 110.8% | 16.22% | 18.48% | 0.9069 | -26.88% |
| 50 | 130.84% | 18.37% | 18.02% | 1.0272 | -26.13% |
| 60 | 124.77% | 17.74% | 17.62% | 1.0157 | -25.96% |
| 70 | 103.94% | 15.45% | 17.3% | 0.9179 | -24.88% |
| 80 | 110.3% | 16.17% | 16.98% | 0.9683 | -25.02% |
| 90 | 109.22% | 16.05% | 16.72% | 0.9747 | -26.26% |
| 100 | 100.2% | 15.02% | 16.56% | 0.9287 | -26.67% |

看起來表現相當不錯，但有可能是買入大量低市值的公司造成回測績效很好，但實務上無法執行的問題。
所以我們需要加入市值的限制條件。

### 2. 排除小市值


- 回測期間：20140101-20190210
- 策略：選出分數前n高的公司進場。

- 限制：
    - **交易量**五日均量須超過1000張(約300-500家)
    - **市值**在過去一年內累積總和需要達到市場前90%(約200家)

每月篩選出的股票數

| n | 累計收益率 | 年化收益率 |年化標準差 | 年化夏普比率 | 最大回撤率 |
|:-:|:-:|:-:|:-:|:-:|:-:|
| 10 | 34.73% | 6.19% | 21.23% | 0.3898 | -40.06% |
| 20 | 50.24% | 8.55% | 18.09% | 0.5446 | -28.16% |
| 30 | 52.56% | 8.89% | 17.08% | 0.5846 | -27.85% |
| 40 | 57.98% | 9.66% | 16.24% | 0.6495 | -28.31% |
| 50 | 57.87% | 9.64% | 15.87% | 0.6602 | -28.42% |
| 60 | 52.82% | 8.93% | 15.41% | 0.6325 | -26.4% |
| 70 | 47.73% | 8.18% | 15.2% | 0.5942 | -25.12% |
| 80 | 42.83% | 7.45% | 15.05% | 0.5533 | -25.55% |
| 90 | 39.03% | 6.87% | 14.94% | 0.5199 | -25.17% |
| 100 | 40.6% | 7.11% | 14.84% | 0.5377 | -26.1% |


其中取30檔、50檔與75檔績效如下
- 30
![](https://i.imgur.com/NYYoZod.png)



- 50
![](https://i.imgur.com/ubLHEzF.png)



- 70

![](https://i.imgur.com/Ykrsk82.png)

- 交易成本
- 從30黨開始放